<!--
@license
FSN App
Copyright (C) 2017  Pedro Rodrigues <prodrigues1990@gmail.com>

This file is part of FSN App.

FSN App is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, version 2 of the License.

FSN App is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with FSN App.  If not, see <http://www.gnu.org/licenses/>.
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="moment-js.html">
<link rel="import" href="shared-styles.html">

<dom-module id="fsn-vatsim-events-view">
  <template is="dom-bind">
    <style include="shared-styles">
      :host {
        display: flex;
        flex-wrap: wrap;
        height: calc(100vh - 64px);
        padding: 16px;
      }
      paper-card {
        --paper-card: {
          flex: 1 1 calc(45% - 1em);

          overflow: hidden;
          min-width: 350px;
          margin: 16px;
        }
      }

      .card-header {
        color: var(--text-secondary-color);
        @apply --paper-font-display1;
      }
      .card-location {
        color: var(--primary-text-color);
        @apply --paper-font-body2;
      }
    </style>

    <iron-ajax
      id="ajax"
      url="https://vateud-events-api.herokuapp.com/events"
      last-response="{{data}}">
    </iron-ajax>

    <iron-scroll-threshold
      id="scrollThreshold"
      lower-threshold="500"
      on-lower-threshold="_loadMoreData">
    </iron-scroll-threshold>

    <template
      is="dom-repeat"
      items="{{items}}"
      scroll-target="scrollThreshold"
      id="domRepeat">
      <paper-card image="[[item.banner_url]]">
      <div class="card-content">
        <div class="card-header">[[item.title]]
          <div class="card-location card-light">
            <iron-icon icon="communication:location-on"></iron-icon>
          </div>
        </div>
        <p>$ãƒ»[[item.airports]]</p>
        <p class="card-light">Small plates, salads &amp; sandwiches in an intimate setting.</p>
      </div>
      <div class="card-actions">
        <div class="horizontal justified">
          <paper-icon-button icon="icons:event"></paper-icon-button>
          <paper-button>[[item.starts]]</paper-button>
          <paper-button>[[item.ends]]</paper-button>
        </div>
      </div>
    </paper-card>
    </template>

  </template>

  <script>
    class FsnVatsimEventsView extends Polymer.Element {
      static get is() { return 'fsn-vatsim-events-view'; }

      static get properties() {
        return {
          items: {
            type: Array,
            notify: true,
            value: []
          },
          data: {
            type: Object,
            value: {}
          }
        };
      }

      ready() {
        super.ready();

        this.$.ajax.url = this._generateUrl({});
        this.$.ajax.generateRequest();
      }

      static get observers() {
        return [
          '_onDataReceive(data)',
        ];
      }

      _onDataReceive(data) {
        // there is nothing for us to see here
        if (data == undefined) {
          return false;
        }

        // trigger stuff on the iron-scroll-threshold thingy
        this.$.scrollThreshold.clearTriggers();

        if (data._links) {
          this.$.ajax.url = this._generateUrl(data._links);
        }

        moment.updateLocale('en-fsn', {
          language: 'en',
          timeFormat: 24,
          units: 'metric'
        });
        // populate the item list
        if (data._items != undefined) {
          for (let item of data._items) {
            this.items.push({
              'title': item.title,
              'subtitle': item.subtitle,
              'banner_url': item.banner_url,
              'ends': moment(item.ends).calendar(),
              'starts': moment(item.starts).calendar()
            });
          }
        }
        // dom-repeat isn't picking up the changes, so we need to force render
        this.$.domRepeat.render();

        return true;
      }

      _generateUrl(links) {
        return [
          [
            "https://vateud-events-api.herokuapp.com",
            (links.next) ? links.next.href + '&' : "events?"
          ].join('/'),
          [
            'where=' + JSON.stringify({
              "starts": {
                "$gte": moment().startOf('day')
                        .format('YYYY-MM-DD\\THH:mm:ss\\Z')
              }
            }),
            'sort=starts'
          ].join('&')
        ].join('');
      }

      _loadMoreData() {
        console.log('load more');
        if (this.$.ajax.activeRequests.length == 0) {
          this.$.ajax.generateRequest();
        }
      }
    }

    window.customElements.define(FsnVatsimEventsView.is, FsnVatsimEventsView);
  </script>
</dom-module>
