<!--
@license
FSN App
Copyright (C) 2017  Pedro Rodrigues <prodrigues1990@gmail.com>

This file is part of FSN App.

FSN App is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, version 2 of the License.

FSN App is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with FSN App.  If not, see <http://www.gnu.org/licenses/>.
-->
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="shared-styles.html">

<dom-module id="fsn-vatsim-map-view">
  <template is="dom-bind">
    <style include="shared-styles">
      :host {
        display: block;
        height: calc(100vh - 64px);
      }
      paper-progress {
        width: 100%;
      }
      google-map {
        height: 100%;
      }
    </style>

    <iron-ajax
        id="clientsAjax"
        handle-as="json"
        loading="{{_clientsAjaxLoading}}">
    </iron-ajax>

    <paper-progress
      id="progressBar">
    </paper-progress>
    <google-map
      id="map"
      api-key="AIzaSyDj4y39JAORYGw4rNcA1y8oVj0m8lNDje4"
      drag-events="true">
    </google-map>

  </template>

  <script src="google.maps.prototypes.js"></script>
  <script>
    class FsnVatsimMapView extends Polymer.Element {
      static get is() { return 'fsn-vatsim-map-view'; }

      static get properties() {
        return {
          viewport: {
            type: Object,
            notify: true,
            value: null
          }
        }
      }

      static get observers() {
        return [
            '_clientsAjaxLoadingChanged(_clientsAjaxLoading)'
        ]
      }

      ready() {
        super.ready();
      }

      connectedCallback() {
        super.connectedCallback();
        // map events binding
        this.$.map.addEventListener(
          'latitude-changed',
          e => {this._mapDragCallback(e)});
        this.$.map.addEventListener(
          'longitude-changed',
          e => {this._mapDragCallback(e)});
        this.$.map.addEventListener(
          'zoom-changed',
          e => {this._mapDragCallback(e)});
          this.$.map.addEventListener(
          'google-map-ready',
          e => {registerGoogleMapsPrototypes()});
      }

      /**
       * Grabs the center position visible on the map
       */
      _mapDragCallback() {
        let viewport = this.$.map.map.getBounds();
        // parse corners
        let NE = viewport.getNorthEast();
        let SW = viewport.getSouthWest();
        let NW = new google.maps.LatLng(NE.lat(), SW.lng());
        let SE = new google.maps.LatLng(SW.lat(), NE.lng());

        if (this.viewport) {
          this.viewport.setMap(null);
        }
        let geometry = [NE, NW, SW, SE];
        console.log(JSON.stringify(SE));
        this.viewport = new google.maps.Polygon({
          paths: geometry,
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.35
        });
        this.viewport.setMap(this.$.map.map);
      }

      /**
       * Computes the diagonal distance, in meters, visible on the map
       */
      _mapZoomCallback() {
        this.mapComputedViewPort = this.$.map.map.getBounds();
        console.log(this.mapComputedViewPort.toJSON());
      }

      _frameCallback() {
        console.log('_frameCallback');
      }

      _clientsAjaxLoadingChanged() {
        if (_clientsAjaxLoading) {
          this.$.progressBar.indeterminate = true;
        } else {
          this.$.progressBar.indeterminate = false;
        }
      }
    }

    window.customElements.define(FsnVatsimMapView.is, FsnVatsimMapView);
  </script>
</dom-module>
