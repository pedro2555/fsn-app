<!--
@license
FSN App
Copyright (C) 2017  Pedro Rodrigues <prodrigues1990@gmail.com>

This file is part of FSN App.

FSN App is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, version 2 of the License.

FSN App is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with FSN App.  If not, see <http://www.gnu.org/licenses/>.
-->
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="shared-styles.html">

<dom-module id="fsn-vatsim-map-view">
  <template is="dom-bind">
    <style include="shared-styles">
      :host {
        display: block;
        height: calc(100vh - 64px);
      }
      paper-progress {
        width: 100%;
      }
      google-map {
        height: 100%;
      }
    </style>

    <iron-ajax
        id="clientsAjax"
        handle-as="json"
        response="{{_clientAjaxResponse}}">
    </iron-ajax>

    <paper-progress
      id="progressBar">
    </paper-progress>
    <google-map
      id="map"
      api-key="AIzaSyDj4y39JAORYGw4rNcA1y8oVj0m8lNDje4"
      drag-events="true">
    </google-map>

  </template>

  <script src="google.maps.prototypes.js"></script>
  <script>
    class FsnVatsimMapView extends Polymer.Element {
      static get is() { return 'fsn-vatsim-map-view'; }

      static get properties() {
        return {
          requestViewport: {
            type: Object,
            value: null
          },
          viewport: {
            type: Object,
            notify: true,
            value: null
          }
        }
      }

      static get observers() {
        return [
            '_clientAjaxResponseChanged(_clientAjaxResponse)'
        ]
      }

      ready() {
        super.ready();
      }

      connectedCallback() {
        super.connectedCallback();
        this.$.clientsAjax.addEventListener(
          'response-changed',
          this._clientAjaxResponseChanged
        );
        // map events binding
        this.$.map.addEventListener(
          'latitude-changed',
          e => {this._mapDragCallback(e)});
        this.$.map.addEventListener(
          'longitude-changed',
          e => {this._mapDragCallback(e)});
        this.$.map.addEventListener(
          'zoom-changed',
          e => {this._mapDragCallback(e)});
          this.$.map.addEventListener(
          'google-map-ready',
          e => {registerGoogleMapsPrototypes()});
      }

      /**
       * Grabs the center position visible on the map
       */
      _mapDragCallback() {
        let viewport = this.$.map.map.getBounds();

        if (this._checkViewportForUpdate(viewport)) {
          this.requestViewport = viewport;
          // this.requestViewport = viewport.inflate(
          //   viewport.getLongestDistance() * .5);
          console.log('get some data');
        }
      }

      /**
       * Validates the last gathered data and returns true if any of the
       * checked paremeters indicate the current data is not up to date or
       * falls outside the current viewport
       *
       * @param {google.maps.LatLngBounds} viewport - OPTIONAL the current
       * visible map area
       */
      _checkViewportForUpdate(viewport=null) {
        // get the first planes going
        if (!this.requestViewport) {
          return true;
        }

        if (viewport != null) {
          // check if we've moved to far since the last request
          if (viewport.fallsOutside(this.requestViewport)) {
            return true;
          }
        }

        // TODO: check for the last time we've gathered data

        return false;
      }

      _clientAjaxResponseChanged() {
        console.log('response: ' + this.$._clientAjaxResponse);
      }
    }

    window.customElements.define(FsnVatsimMapView.is, FsnVatsimMapView);
  </script>
</dom-module>
